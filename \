import { Component, ViewChild, ElementRef } from '@angular/core';
import { Router } from '@angular/router';
import { AlertController, IonList, LoadingController, ModalController, ToastController, Config } from '@ionic/angular';
import { ConferenceData } from '../../providers/conference-data';
import { UserData } from '../../providers/user-data';
import { OpportunityService } from '../../services/opportunity.service';
import { PosOrderService } from '../../services/pos-order.service';
import { TableService } from '../../services/table.service';
import { environment } from '../../../environments/environment';
import { ActivatedRoute } from '@angular/router'
import { Session } from '../../interfaces/session';
import { SessionService } from '../../services/session.service';
import { UtilService } from '../../services/util.service';
import { ProductService } from '../../services/product.service';
import { BarcodeService } from '../../services/barcode.service';
import { CategoryService } from '../../services/category.service';
import { BrowserMultiFormatReader } from '@zxing/browser';


@Component({
  selector: 'page-schedule',
  templateUrl: 'schedule.html',
  styleUrls: ['./schedule.scss'],
})
export class SchedulePage {
  @ViewChild('video', { static: false }) videoElement!: ElementRef<HTMLVideoElement>;


  scannedValue: string = '';
  private codeReader = new BrowserMultiFormatReader();
  private selectedDeviceId: string | null = null;
  // printSelectedBarcodes
  ios: boolean;
  segment = 'all';
  showSearchbar: boolean;
  //opportunities = [];
  //storedObject: any;
  //posOrders: any[] = [];
  //posOrderLineList: any[] = [];
  //pendingCommands: any[] = [];
  //deliveredList: any[] = [];
  productList: any[] = [];
  filteredProductList: any[] = [];
  maxQtyDeliveredItems: any[] = [];
  queryText:any
  //mesas: any[] = [];
  //activeSession: Session | null = null;
  //sessionId: number | null = null;

  constructor(
    private barcodeService: BarcodeService,
    public alertCtrl: AlertController,
    public confData: ConferenceData,
    public loadingCtrl: LoadingController,
    public modalCtrl: ModalController,
    public router: Router,
    public toastCtrl: ToastController,
    public user: UserData,
    public config: Config,
    private opportunityService: OpportunityService,
    private route: ActivatedRoute,
    private sessionService:SessionService,
    private utilService:UtilService,
    private productService: ProductService,
    private categoryService: CategoryService
  ) {}


  ionViewDidEnter() {
    this.loadCategories();
    this.loadUms();
    this.loadProduct(110);
  }

    async startScan() {
      try {
        const devices = await BrowserMultiFormatReader.listVideoInputDevices();
        if (!devices.length) {
          console.error('No se encontraron cÃ¡maras');
          return;
        }

        // Filtra solo cÃ¡maras traseras
        const backCamera = devices.find(d =>
          d.label.toLowerCase().includes('back') ||
          d.label.toLowerCase().includes('rear') ||
          d.label.toLowerCase().includes('trÃ¡s') ||
          d.label.toLowerCase().includes('principal')
        );

        if (!backCamera) {
          console.error('No se detectÃ³ cÃ¡mara trasera');
          return;
        }

        console.log('Usando cÃ¡mara trasera:', backCamera.label);

        this.codeReader.decodeFromVideoDevice(
          backCamera.deviceId,
          this.videoElement.nativeElement,
          (result, err) => {
            if (result) {
              this.scannedValue = result.getText();
              console.log('CÃ³digo leÃ­do:', this.scannedValue);
              this.stopScan(); // detiene la cÃ¡mara despuÃ©s de leer
            }
            if (err && !(err.name === 'NotFoundException')) {
              console.error(err);
            }
          }
        );
      } catch (error) {
        console.error('Error al acceder a la cÃ¡mara trasera:', error);
      }
    }


    stopScan() {
      try {
        // Algunas versiones usan stopStreams(), otras reset()
        if ((this.codeReader as any).stopStreams) {
          (this.codeReader as any).stopStreams();
        } else if ((this.codeReader as any).reset) {
          (this.codeReader as any).reset();
        }

        const video = this.videoElement?.nativeElement;
        if (video && video.srcObject instanceof MediaStream) {
          video.srcObject.getTracks().forEach(track => track.stop());
          video.srcObject = null;
        }

        console.log('Escaneo detenido correctamente');
      } catch (e) {
        console.warn('Error al detener la cÃ¡mara:', e);
      }
    }

    product:any
    loadProduct(id: number) {
      this.productService.getProductById(id).subscribe(data => {
        this.product = data[0]; // ðŸ‘ˆ PostgREST devuelve un array
        console.log('Producto:', this.product);
      });
    }


categories: any[] = [];

loadCategories() {
  this.categoryService.getAllCategories().subscribe({
    next: (res) => {
      console.log('âœ… CategorÃ­as:', res);
      this.categories = res;
      this.categoryService.saveCategoriesToLocal(res); // Guarda en localStorage
    },
    error: (err) => {
      console.error('âŒ Error al cargar categorÃ­as:', err);
      // Si falla el backend, intenta usar las locales
      this.categories = this.categoryService.getCategoriesFromLocal();
      console.log('ðŸ“¦ CategorÃ­as cargadas desde localStorage:', this.categories);
    }
  });
}


ums: any[] = [];

loadUms() {
  this.categoryService.getAllCategories().subscribe({
    next: (res) => {
      console.log('âœ… Ums:', res);
      this.ums = res;
      this.categoryService.saveCategoriesToLocal(res); // Guarda en localStorage
    },
    error: (err) => {
      console.error('âŒ Error al cargar categorÃ­as:', err);
      // Si falla el backend, intenta usar las locales
      this.categories = this.categoryService.getCategoriesFromLocal();
      console.log('ðŸ“¦ CategorÃ­as cargadas desde localStorage:', this.categories);
    }
  });
}


getCategoryNameById(id: number): string {
  const cat = this.categories.find(c => c.id === id);
  return cat ? cat.datos?.nombre || 'Sin categorÃ­a' : 'Sin categorÃ­a';
}



getUmNameById(id: number): string {
  const um = this.ums.find(c => c.id === id);
  return um ? um.datos?.nombre || 'Unid.' : 'Unid';
}


updateSchedule(){}

hash:string='';
table:any
ngOnInit() {
  this.loadProduct(110);
}

}




